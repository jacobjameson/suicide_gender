---
title: "Analysis"
format: html
editor: visual
---

```{r}
library(ggsci)
```

```{r, message=FALSE, warning=F}
source('src/prepare data.R')
names(data)
```

```{r, message=FALSE, warning=F, fig.width=10, fig.height=6, echo=FALSE}
data %>%
  group_by(mech, age_code, gender) %>%
  summarize(sum = sum(crude_rate, na.rm = T)) %>%
  mutate(gender = case_when(
    gender == 'Male' ~ 'Male Suicides',
    TRUE ~ 'Female Suicides'
  )) %>%
  ggplot(aes(x = age_code, 
             y = sum,
             color = gender)) +
  scale_fill_lancet() +
  scale_color_lancet() +
  xlim(12,80) + 
  geom_smooth(aes(fill = gender), size = 1, method = "loess") + 
  facet_wrap(~mech) + 
  labs(title = "Suicide Deaths per 100,000 by Age and Sex",
       subtitle = "Data Years: 2018 to 2022, United States, All Races, All Ethnicities",
       x = "Age",
       y = "Suicides per 100,000",
       color = "Sex",
       fill = "Sex") +
  theme_minimal(base_size = 16) +  
  theme(
    plot.background = element_rect(fill = 'white', color = NA), 
    axis.text = element_text(color = 'black', size = 18),  
    plot.title = element_text(size = 22, face = 'bold', color = 'black'),
    panel.grid.major = element_line(color = 'grey85', size = 0.3),
    panel.grid.minor = element_blank(),  
    legend.position = 'bottom',
    plot.caption = element_text(size = 9, hjust = 0),
    axis.title = element_text(size = 20, color = 'black'),  
    strip.text.x = element_text(size = 18, face = "bold", color = 'black') ,
    axis.line = element_line(colour = "black")
  ) 

ggsave("outputs/f1.png", width = 10, height = 6, dpi = 300)

```

```{r, message=FALSE, warning=F, fig.width=10, fig.height=7, echo=FALSE}
data %>%
  mutate(gender = case_when(
    gender == 'Male' ~ 'Male Differences',
    TRUE ~ 'Female Differences'
  )) %>%
  ggplot(aes(x = age_code, 
             y = crude_rate,
             color = gender, linetype = grade)) +
  xlim(12,80) + 
  geom_smooth(aes(fill = gender), size = 1, method = "loess") + 
  facet_wrap(~mech) + 
  scale_fill_lancet() +
  scale_color_lancet() +
  labs(title = "Suicide Deaths per 100,000 by Age \nAcross More and Less Gun-Strict States",
       subtitle = "Data Years: 2018 to 2022, United States, All Races, All Ethnicities",
       x = "Age",
       y = "Suicides per 100,000",
       color = "Sex",
       fill = "Sex",
       linetype = 'Gun Law Score') +
  theme_minimal(base_size = 16) +  
  theme(
    plot.background = element_rect(fill = 'white', color = NA), 
    axis.text = element_text(color = 'black', size = 18),  
    plot.title = element_text(size = 22, face = 'bold', color = 'black'),
    panel.grid.major = element_line(color = 'grey85', size = 0.3),
    panel.grid.minor = element_blank(),  
    legend.position = 'bottom',
    plot.caption = element_text(size = 9, hjust = 0),
    axis.title = element_text(size = 20, color = 'black'),  
    strip.text.x = element_text(size = 18, face = "bold", color = 'black') ,
    axis.line = element_line(colour = "black")
  ) 

ggsave("outputs/f2.png", width = 10, height = 7, dpi = 300)

```

### Data Preparation and Assumption Testing

To explore the differences in crude rates by age group, stratified by gender, mechanism of injury (mech), and legislative grading (grade), we first prepared our dataset by categorizing ages into five-year groups. We then assessed the assumptions required for the application of Analysis of Variance (ANOVA). The Shapiro-Wilk test was employed to evaluate the normality of the distribution of crude rates within the subsets of data. For the combination of "Permissive" grade, "Firearm" mechanism, and female gender, the Shapiro-Wilk test resulted in a W-value of 0.97818 with a p-value of 0.2367, indicating no significant deviation from normality. Additionally, the homogeneity of variances across the age groups was assessed using Bartlett's test, which yielded a K-squared value of 16.865 with 14 degrees of freedom and a p-value of 0.2635, confirming the assumption of equal variances among the groups.

### ANOVA

We performed a factorial ANOVA to determine the effects of age group, gender, mechanism, and grade on crude rates, along with their interactions. The model included main effects and interaction terms up to the four-way interaction between age group, gender, mech, and grade. The ANOVA results indicated significant effects for all main factors and their interactions (p \< 0.05), suggesting substantial differences in crude rates associated with these factors. For instance, the main effects of gender (F(1, 465) = 17803.084, p \< 2e-16) and mechanism (F(1, 465) = 634.882, p \< 2e-16) were highly significant, highlighting their strong influence on crude rates. Interaction effects such as age group by gender (F(14, 465) = 149.611, p \< 2e-16) and the four-way interaction between all factors (F(14, 465) = 5.404, p = 1.28e-09) were also significant, indicating that the relationship between these variables and crude rates varies across different groupings.

### Post-hoc Analysis

Given the significance of the interaction terms in the ANOVA, we conducted post-hoc comparisons using Tukey's Honest Significant Difference (HSD) test to further explore which specific group differences were statistically significant. This method adjusts for multiple comparisons and is appropriate for pairwise comparisons following a significant ANOVA. Tukey's HSD test helps to identify specific pairs of groups where the differences in mean crude rates are statistically significant beyond the random chance, providing a detailed understanding of how these factors interact to affect the outcome variable.

### Discussion of Results

The results from the factorial ANOVA and subsequent post-hoc analysis provide comprehensive insights into how demographic and legislative factors interact to influence crude rates of outcomes. By confirming significant interactions between these factors, we can infer that the impact of legislation, mechanism of injury, and gender on health outcomes is not uniform across different age groups.

```{r}
# Assuming age_code directly translates to each year
data$age_group <- cut(data$age_code, breaks=seq(0, 100, by=5), right=FALSE,
                      labels=paste(seq(0, 95, by=5), seq(4, 99, by=5), sep="-"))



# Example check for normality for one combination
shapiro.test(data$crude_rate[data$grade == "Permissive" & data$mech == "Firearm" & data$gender == "Female"])

# Example check for equal variance
bartlett.test(crude_rate ~ age_group, data = data[data$grade == "Permissive" & data$mech == "Firearm" & data$gender == "Female",])


# Run ANOVA and get a summary
anova_result <- aov(crude_rate ~ age_group * gender * mech * grade, data = data)
summary(anova_result)

# Post-hoc test using Tukey's HSD
df <- TukeyHSD(anova_result) %>% broom::tidy() %>% 
  mutate(significant = adj.p.value < 0.05) 

for (term in unique(df$term)) {
  write.csv(df[df$term == term,], paste0('outputs/' ,term, ".csv"))
}


unique(df$term)
```

```{r}
# Table 1. Suicides, Stratified by Sex
groups <- c('10-14:Male:Firearm-10-14:Female:Firearm',
            '15-19:Male:Firearm-15-19:Female:Firearm',
            '20-24:Male:Firearm-20-24:Female:Firearm',
            '25-29:Male:Firearm-25-29:Female:Firearm',
            '30-34:Male:Firearm-30-34:Female:Firearm',
            '35-39:Male:Firearm-35-39:Female:Firearm',
            '40-44:Male:Firearm-40-44:Female:Firearm',
            '45-49:Male:Firearm-45-49:Female:Firearm',
            '50-54:Male:Firearm-50-54:Female:Firearm',
            '55-59:Male:Firearm-55-59:Female:Firearm',
            '60-64:Male:Firearm-60-64:Female:Firearm',
            '65-69:Male:Firearm-65-69:Female:Firearm',
            '70-74:Male:Firearm-70-74:Female:Firearm',
            '75-79:Male:Firearm-75-79:Female:Firearm',
            '80-84:Male:Firearm-80-84:Female:Firearm',
            
            '10-14:Male:Non-Firearm-10-14:Female:Non-Firearm',
            '15-19:Male:Non-Firearm-15-19:Female:Non-Firearm',
            '20-24:Male:Non-Firearm-20-24:Female:Non-Firearm',
            '25-29:Male:Non-Firearm-25-29:Female:Non-Firearm',
            '30-34:Male:Non-Firearm-30-34:Female:Non-Firearm',
            '35-39:Male:Non-Firearm-35-39:Female:Non-Firearm',
            '40-44:Male:Non-Firearm-40-44:Female:Non-Firearm',
            '45-49:Male:Non-Firearm-45-49:Female:Non-Firearm',
            '50-54:Male:Non-Firearm-50-54:Female:Non-Firearm',
            '55-59:Male:Non-Firearm-55-59:Female:Non-Firearm',
            '60-64:Male:Non-Firearm-60-64:Female:Non-Firearm',
            '65-69:Male:Non-Firearm-65-69:Female:Non-Firearm',
            '70-74:Male:Non-Firearm-70-74:Female:Non-Firearm',
            '75-79:Male:Non-Firearm-75-79:Female:Non-Firearm',
            '80-84:Male:Non-Firearm-80-84:Female:Non-Firearm',
            
            '10-14:Male:Total-10-14:Female:Total',
            '15-19:Male:Total-15-19:Female:Total',
            '20-24:Male:Total-20-24:Female:Total',
            '25-29:Male:Total-25-29:Female:Total',
            '30-34:Male:Total-30-34:Female:Total',
            '35-39:Male:Total-35-39:Female:Total',
            '40-44:Male:Total-40-44:Female:Total',
            '45-49:Male:Total-45-49:Female:Total',
            '50-54:Male:Total-50-54:Female:Total',
            '55-59:Male:Total-55-59:Female:Total',
            '60-64:Male:Total-60-64:Female:Total',
            '65-69:Male:Total-65-69:Female:Total',
            '70-74:Male:Total-70-74:Female:Total',
            '75-79:Male:Total-75-79:Female:Total',
            '80-84:Male:Total-80-84:Female:Total')


df %>% filter(term == 'age_group:gender:mech',
              contrast %in% groups) %>%
  cbind(
data %>%
  group_by(age_group, gender, mech) %>%
  summarise(crude_rate = mean(crude_rate, na.rm = T)) %>%
  pivot_wider(names_from = gender, values_from = crude_rate, names_prefix = "crude_rate_") %>%
  filter(age_group != '0-4', age_group != '5-9') %>% ungroup() %>%
  arrange(mech, age_group)) %>%
  dplyr::select(term, contrast, estimate, conf.low, conf.high, crude_rate_Female, crude_rate_Male, significant) %>%
  write.csv('outputs/Table1.csv')


df %>% filter(term == 'age_group:gender:mech')
```

```{r}
#Table 2. Male Suicides, Stratified by State Policy Environment

groups <- c('10-14:Male:Firearm:Strict-10-14:Male:Firearm:Permissive',
            '15-19:Male:Firearm:Strict-15-19:Male:Firearm:Permissive',
            '20-24:Male:Firearm:Strict-20-24:Male:Firearm:Permissive',
            '25-29:Male:Firearm:Strict-25-29:Male:Firearm:Permissive',
            '30-34:Male:Firearm:Strict-30-34:Male:Firearm:Permissive',
            '35-39:Male:Firearm:Strict-35-39:Male:Firearm:Permissive',
            '40-44:Male:Firearm:Strict-40-44:Male:Firearm:Permissive',
            '45-49:Male:Firearm:Strict-45-49:Male:Firearm:Permissive',
            '50-54:Male:Firearm:Strict-50-54:Male:Firearm:Permissive',
            '55-59:Male:Firearm:Strict-55-59:Male:Firearm:Permissive',
            '60-64:Male:Firearm:Strict-60-64:Male:Firearm:Permissive',
            '65-69:Male:Firearm:Strict-65-69:Male:Firearm:Permissive',
            '70-74:Male:Firearm:Strict-70-74:Male:Firearm:Permissive',
            '75-79:Male:Firearm:Strict-75-79:Male:Firearm:Permissive',
            '80-84:Male:Firearm:Strict-80-84:Male:Firearm:Permissive',
            
            '10-14:Male:Non-Firearm:Strict-10-14:Male:Non-Firearm:Permissive',
            '15-19:Male:Non-Firearm:Strict-15-19:Male:Non-Firearm:Permissive',
            '20-24:Male:Non-Firearm:Strict-20-24:Male:Non-Firearm:Permissive',
            '25-29:Male:Non-Firearm:Strict-25-29:Male:Non-Firearm:Permissive',
            '30-34:Male:Non-Firearm:Strict-30-34:Male:Non-Firearm:Permissive',
            '35-39:Male:Non-Firearm:Strict-35-39:Male:Non-Firearm:Permissive',
            '40-44:Male:Non-Firearm:Strict-40-44:Male:Non-Firearm:Permissive',
            '45-49:Male:Non-Firearm:Strict-45-49:Male:Non-Firearm:Permissive',
            '50-54:Male:Non-Firearm:Strict-50-54:Male:Non-Firearm:Permissive',
            '55-59:Male:Non-Firearm:Strict-55-59:Male:Non-Firearm:Permissive',
            '60-64:Male:Non-Firearm:Strict-60-64:Male:Non-Firearm:Permissive',
            '65-69:Male:Non-Firearm:Strict-65-69:Male:Non-Firearm:Permissive',
            '70-74:Male:Non-Firearm:Strict-70-74:Male:Non-Firearm:Permissive',
            '75-79:Male:Non-Firearm:Strict-75-79:Male:Non-Firearm:Permissive',
            '80-84:Male:Non-Firearm:Strict-80-84:Male:Non-Firearm:Permissive',
            
            '10-14:Male:Total:Strict-10-14:Male:Total:Permissive',
            '15-19:Male:Total:Strict-15-19:Male:Total:Permissive',
            '20-24:Male:Total:Strict-20-24:Male:Total:Permissive',
            '25-29:Male:Total:Strict-25-29:Male:Total:Permissive',
            '30-34:Male:Total:Strict-30-34:Male:Total:Permissive',
            '35-39:Male:Total:Strict-35-39:Male:Total:Permissive',
            '40-44:Male:Total:Strict-40-44:Male:Total:Permissive',
            '45-49:Male:Total:Strict-45-49:Male:Total:Permissive',
            '50-54:Male:Total:Strict-50-54:Male:Total:Permissive',
            '55-59:Male:Total:Strict-55-59:Male:Total:Permissive',
            '60-64:Male:Total:Strict-60-64:Male:Total:Permissive',
            '65-69:Male:Total:Strict-65-69:Male:Total:Permissive',
            '70-74:Male:Total:Strict-70-74:Male:Total:Permissive',
            '75-79:Male:Total:Strict-75-79:Male:Total:Permissive',
            '80-84:Male:Total:Strict-80-84:Male:Total:Permissive')


df %>% filter(term == 'age_group:gender:mech:grade',
              contrast %in% groups) %>%
  cbind(
  data %>%
  filter(gender == 'Male') %>%
  group_by(age_group, mech, grade) %>%
  summarise(crude_rate = mean(crude_rate, na.rm = T)) %>%
  pivot_wider(names_from = grade, values_from = crude_rate, names_prefix = "crude_rate_") %>%
  filter(age_group != '0-4', age_group != '5-9') %>% ungroup() %>%
  arrange(mech, age_group)) %>%
  write.csv('outputs/Table2.csv')
```

```{r}
#Table 3. Female Suicides, Stratified by State Policy Environment
groups <- c('10-14:Female:Firearm:Strict-10-14:Female:Firearm:Permissive',
            '15-19:Female:Firearm:Strict-15-19:Female:Firearm:Permissive',
            '20-24:Female:Firearm:Strict-20-24:Female:Firearm:Permissive',
            '25-29:Female:Firearm:Strict-25-29:Female:Firearm:Permissive',
            '30-34:Female:Firearm:Strict-30-34:Female:Firearm:Permissive',
            '35-39:Female:Firearm:Strict-35-39:Female:Firearm:Permissive',
            '40-44:Female:Firearm:Strict-40-44:Female:Firearm:Permissive',
            '45-49:Female:Firearm:Strict-45-49:Female:Firearm:Permissive',
            '50-54:Female:Firearm:Strict-50-54:Female:Firearm:Permissive',
            '55-59:Female:Firearm:Strict-55-59:Female:Firearm:Permissive',
            '60-64:Female:Firearm:Strict-60-64:Female:Firearm:Permissive',
            '65-69:Female:Firearm:Strict-65-69:Female:Firearm:Permissive',
            '70-74:Female:Firearm:Strict-70-74:Female:Firearm:Permissive',
            '75-79:Female:Firearm:Strict-75-79:Female:Firearm:Permissive',
            '80-84:Female:Firearm:Strict-80-84:Female:Firearm:Permissive',
            
            '10-14:Female:Non-Firearm:Strict-10-14:Female:Non-Firearm:Permissive',
            '15-19:Female:Non-Firearm:Strict-15-19:Female:Non-Firearm:Permissive',
            '20-24:Female:Non-Firearm:Strict-20-24:Female:Non-Firearm:Permissive',
            '25-29:Female:Non-Firearm:Strict-25-29:Female:Non-Firearm:Permissive',
            '30-34:Female:Non-Firearm:Strict-30-34:Female:Non-Firearm:Permissive',
            '35-39:Female:Non-Firearm:Strict-35-39:Female:Non-Firearm:Permissive',
            '40-44:Female:Non-Firearm:Strict-40-44:Female:Non-Firearm:Permissive',
            '45-49:Female:Non-Firearm:Strict-45-49:Female:Non-Firearm:Permissive',
            '50-54:Female:Non-Firearm:Strict-50-54:Female:Non-Firearm:Permissive',
            '55-59:Female:Non-Firearm:Strict-55-59:Female:Non-Firearm:Permissive',
            '60-64:Female:Non-Firearm:Strict-60-64:Female:Non-Firearm:Permissive',
            '65-69:Female:Non-Firearm:Strict-65-69:Female:Non-Firearm:Permissive',
            '70-74:Female:Non-Firearm:Strict-70-74:Female:Non-Firearm:Permissive',
            '75-79:Female:Non-Firearm:Strict-75-79:Female:Non-Firearm:Permissive',
            '80-84:Female:Non-Firearm:Strict-80-84:Female:Non-Firearm:Permissive',
            
            '10-14:Female:Total:Strict-10-14:Female:Total:Permissive',
            '15-19:Female:Total:Strict-15-19:Female:Total:Permissive',
            '20-24:Female:Total:Strict-20-24:Female:Total:Permissive',
            '25-29:Female:Total:Strict-25-29:Female:Total:Permissive',
            '30-34:Female:Total:Strict-30-34:Female:Total:Permissive',
            '35-39:Female:Total:Strict-35-39:Female:Total:Permissive',
            '40-44:Female:Total:Strict-40-44:Female:Total:Permissive',
            '45-49:Female:Total:Strict-45-49:Female:Total:Permissive',
            '50-54:Female:Total:Strict-50-54:Female:Total:Permissive',
            '55-59:Female:Total:Strict-55-59:Female:Total:Permissive',
            '60-64:Female:Total:Strict-60-64:Female:Total:Permissive',
            '65-69:Female:Total:Strict-65-69:Female:Total:Permissive',
            '70-74:Female:Total:Strict-70-74:Female:Total:Permissive',
            '75-79:Female:Total:Strict-75-79:Female:Total:Permissive',
            '80-84:Female:Total:Strict-80-84:Female:Total:Permissive')


df %>% filter(term == 'age_group:gender:mech:grade',
              contrast %in% groups) %>%
  cbind(
  data %>%
  filter(gender == 'Female') %>%
  group_by(age_group, mech, grade) %>%
  summarise(crude_rate = mean(crude_rate, na.rm = T)) %>%
  pivot_wider(names_from = grade, values_from = crude_rate, names_prefix = "crude_rate_") %>%
  filter(age_group != '0-4', age_group != '5-9') %>% ungroup() %>%
  arrange(mech, age_group)) %>%
  write.csv('outputs/Table3.csv')
```

```{r}
# Table 4. Suicides, Stratified by Sex, within Permissive Policy Environment

groups <- c('10-14:Male:Firearm:Permissive-10-14:Female:Firearm:Permissive',
            '15-19:Male:Firearm:Permissive-15-19:Female:Firearm:Permissive',
            '20-24:Male:Firearm:Permissive-20-24:Female:Firearm:Permissive',
            '25-29:Male:Firearm:Permissive-25-29:Female:Firearm:Permissive',
            '30-34:Male:Firearm:Permissive-30-34:Female:Firearm:Permissive',
            '35-39:Male:Firearm:Permissive-35-39:Female:Firearm:Permissive',
            '40-44:Male:Firearm:Permissive-40-44:Female:Firearm:Permissive',
            '45-49:Male:Firearm:Permissive-45-49:Female:Firearm:Permissive',
            '50-54:Male:Firearm:Permissive-50-54:Female:Firearm:Permissive',
            '55-59:Male:Firearm:Permissive-55-59:Female:Firearm:Permissive',
            '60-64:Male:Firearm:Permissive-60-64:Female:Firearm:Permissive',
            '65-69:Male:Firearm:Permissive-65-69:Female:Firearm:Permissive',
            '70-74:Male:Firearm:Permissive-70-74:Female:Firearm:Permissive',
            '75-79:Male:Firearm:Permissive-75-79:Female:Firearm:Permissive',
            '80-84:Male:Firearm:Permissive-80-84:Female:Firearm:Permissive',
            
            '10-14:Male:Non-Firearm:Permissive-10-14:Female:Non-Firearm:Permissive',
            '15-19:Male:Non-Firearm:Permissive-15-19:Female:Non-Firearm:Permissive',
            '20-24:Male:Non-Firearm:Permissive-20-24:Female:Non-Firearm:Permissive',
            '25-29:Male:Non-Firearm:Permissive-25-29:Female:Non-Firearm:Permissive',
            '30-34:Male:Non-Firearm:Permissive-30-34:Female:Non-Firearm:Permissive',
            '35-39:Male:Non-Firearm:Permissive-35-39:Female:Non-Firearm:Permissive',
            '40-44:Male:Non-Firearm:Permissive-40-44:Female:Non-Firearm:Permissive',
            '45-49:Male:Non-Firearm:Permissive-45-49:Female:Non-Firearm:Permissive',
            '50-54:Male:Non-Firearm:Permissive-50-54:Female:Non-Firearm:Permissive',
            '55-59:Male:Non-Firearm:Permissive-55-59:Female:Non-Firearm:Permissive',
            '60-64:Male:Non-Firearm:Permissive-60-64:Female:Non-Firearm:Permissive',
            '65-69:Male:Non-Firearm:Permissive-65-69:Female:Non-Firearm:Permissive',
            '70-74:Male:Non-Firearm:Permissive-70-74:Female:Non-Firearm:Permissive',
            '75-79:Male:Non-Firearm:Permissive-75-79:Female:Non-Firearm:Permissive',
            '80-84:Male:Non-Firearm:Permissive-80-84:Female:Non-Firearm:Permissive',
            
            '10-14:Male:Total:Permissive-10-14:Female:Total:Permissive',
            '15-19:Male:Total:Permissive-15-19:Female:Total:Permissive',
            '20-24:Male:Total:Permissive-20-24:Female:Total:Permissive',
            '25-29:Male:Total:Permissive-25-29:Female:Total:Permissive',
            '30-34:Male:Total:Permissive-30-34:Female:Total:Permissive',
            '35-39:Male:Total:Permissive-35-39:Female:Total:Permissive',
            '40-44:Male:Total:Permissive-40-44:Female:Total:Permissive',
            '45-49:Male:Total:Permissive-45-49:Female:Total:Permissive',
            '50-54:Male:Total:Permissive-50-54:Female:Total:Permissive',
            '55-59:Male:Total:Permissive-55-59:Female:Total:Permissive',
            '60-64:Male:Total:Permissive-60-64:Female:Total:Permissive',
            '65-69:Male:Total:Permissive-65-69:Female:Total:Permissive',
            '70-74:Male:Total:Permissive-70-74:Female:Total:Permissive',
            '75-79:Male:Total:Permissive-75-79:Female:Total:Permissive',
            '80-84:Male:Total:Permissive-80-84:Female:Total:Permissive')


df %>% filter(term == 'age_group:gender:mech:grade',
              contrast %in% groups) %>%
  cbind(
  data %>%
  filter(grade == 'Permissive') %>%
  group_by(age_group, mech, gender) %>%
  summarise(crude_rate = mean(crude_rate, na.rm = T)) %>%
  pivot_wider(names_from = gender, values_from = crude_rate, names_prefix = "crude_rate_") %>%
  filter(age_group != '0-4', age_group != '5-9') %>% ungroup() %>%
  arrange(mech, age_group)) %>%
  write.csv('outputs/Table4.csv')
```

```{r}
# Table 5. Suicides, Stratified by Sex, within Strict Policy Environment

groups <- c('10-14:Male:Firearm:Strict-10-14:Female:Firearm:Strict',
            '15-19:Male:Firearm:Strict-15-19:Female:Firearm:Strict',
            '20-24:Male:Firearm:Strict-20-24:Female:Firearm:Strict',
            '25-29:Male:Firearm:Strict-25-29:Female:Firearm:Strict',
            '30-34:Male:Firearm:Strict-30-34:Female:Firearm:Strict',
            '35-39:Male:Firearm:Strict-35-39:Female:Firearm:Strict',
            '40-44:Male:Firearm:Strict-40-44:Female:Firearm:Strict',
            '45-49:Male:Firearm:Strict-45-49:Female:Firearm:Strict',
            '50-54:Male:Firearm:Strict-50-54:Female:Firearm:Strict',
            '55-59:Male:Firearm:Strict-55-59:Female:Firearm:Strict',
            '60-64:Male:Firearm:Strict-60-64:Female:Firearm:Strict',
            '65-69:Male:Firearm:Strict-65-69:Female:Firearm:Strict',
            '70-74:Male:Firearm:Strict-70-74:Female:Firearm:Strict',
            '75-79:Male:Firearm:Strict-75-79:Female:Firearm:Strict',
            '80-84:Male:Firearm:Strict-80-84:Female:Firearm:Strict',
            
            '10-14:Male:Non-Firearm:Strict-10-14:Female:Non-Firearm:Strict',
            '15-19:Male:Non-Firearm:Strict-15-19:Female:Non-Firearm:Strict',
            '20-24:Male:Non-Firearm:Strict-20-24:Female:Non-Firearm:Strict',
            '25-29:Male:Non-Firearm:Strict-25-29:Female:Non-Firearm:Strict',
            '30-34:Male:Non-Firearm:Strict-30-34:Female:Non-Firearm:Strict',
            '35-39:Male:Non-Firearm:Strict-35-39:Female:Non-Firearm:Strict',
            '40-44:Male:Non-Firearm:Strict-40-44:Female:Non-Firearm:Strict',
            '45-49:Male:Non-Firearm:Strict-45-49:Female:Non-Firearm:Strict',
            '50-54:Male:Non-Firearm:Strict-50-54:Female:Non-Firearm:Strict',
            '55-59:Male:Non-Firearm:Strict-55-59:Female:Non-Firearm:Strict',
            '60-64:Male:Non-Firearm:Strict-60-64:Female:Non-Firearm:Strict',
            '65-69:Male:Non-Firearm:Strict-65-69:Female:Non-Firearm:Strict',
            '70-74:Male:Non-Firearm:Strict-70-74:Female:Non-Firearm:Strict',
            '75-79:Male:Non-Firearm:Strict-75-79:Female:Non-Firearm:Strict',
            '80-84:Male:Non-Firearm:Strict-80-84:Female:Non-Firearm:Strict',
            
            '10-14:Male:Total:Strict-10-14:Female:Total:Strict',
            '15-19:Male:Total:Strict-15-19:Female:Total:Strict',
            '20-24:Male:Total:Strict-20-24:Female:Total:Strict',
            '25-29:Male:Total:Strict-25-29:Female:Total:Strict',
            '30-34:Male:Total:Strict-30-34:Female:Total:Strict',
            '35-39:Male:Total:Strict-35-39:Female:Total:Strict',
            '40-44:Male:Total:Strict-40-44:Female:Total:Strict',
            '45-49:Male:Total:Strict-45-49:Female:Total:Strict',
            '50-54:Male:Total:Strict-50-54:Female:Total:Strict',
            '55-59:Male:Total:Strict-55-59:Female:Total:Strict',
            '60-64:Male:Total:Strict-60-64:Female:Total:Strict',
            '65-69:Male:Total:Strict-65-69:Female:Total:Strict',
            '70-74:Male:Total:Strict-70-74:Female:Total:Strict',
            '75-79:Male:Total:Strict-75-79:Female:Total:Strict',
            '80-84:Male:Total:Strict-80-84:Female:Total:Strict')


df %>% filter(term == 'age_group:gender:mech:grade',
              contrast %in% groups) %>%
  cbind(
  data %>%
  filter(grade == 'Strict') %>%
  group_by(age_group, mech, gender) %>%
  summarise(crude_rate = mean(crude_rate, na.rm = T)) %>%
  pivot_wider(names_from = gender, values_from = crude_rate, names_prefix = "crude_rate_") %>%
  filter(age_group != '0-4', age_group != '5-9') %>% ungroup() %>%
  arrange(mech, age_group)) %>%
  write.csv('outputs/Table5.csv')
```
